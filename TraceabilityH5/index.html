<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>溯源信息</title>
		<link rel="stylesheet" type="text/css" href="css/index.css" />
		<link rel="stylesheet" type="text/css" href="css/source.css" />
	</head>

	<body>
		<div class="title">
			<img src="img/close.png" class="closeIcon" />
			<h4>溯源信息</h4>
		</div>
		<div class="content">
			<div class="picihao">
				<label>您的批次号为：<span class="greentxt bold picihaoTxt"></span></label>
			</div>
			<div class="imgbox">
				<img src="" class="curImg" />
			</div>
			<div class="parkName">
				<h4 class="zhongmiaomingcheng"></h4>
			</div>
			<div class="time">
				<span>批次时间区间：<label class="createTime"></label> <label class="overTime"></label></span>
			</div>
			<div class="listbox">

				<div class="l-title">
					<span class="name bold">种植过程</span>
					<span class="symbol"></span>
					<span class="greentxt flex-align-center"><img src="img/icon.png" class="icon"/>可追溯</span>
				</div>

				<div class="item">
					<span class="symbolIcon"></span>
					<p>园区名称：<span class="parkNameTxt"></span></p>
					<p>创建时间：<span class="parkTimeTxt"></span></p>
					<p>面积： <span class="parkAreaTxt"></span></p>
					<p>土壤成分：<span class="parkChengfemTxt"></span></p>
				</div>
				<div class="container-fluid">
					<!--<div class="item">
						<span class="symbolIcon"></span>
						<p>松土</p>
						<p>对土壤进行机械松土处理</p>
						<p>平均温湿度 25.5℃ 75%RH</p>
						<p class="timebg">2023/02/03 00:00:00——2023/02/03 00:00:00</p>
					</div>-->
				</div>
				<img src="img/top.png" class="topImg" />
			</div>
		</div>

	</body>
	<script src="js/jquery-1.11.0.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		$(function() {
			var _Trace_code = "";
			var _url = window.location.href;

			function getQueryVariable(variable) {
				var query = window.location.search.substring(1);
				var vars = query.split("&");
				for(var i = 0; i < vars.length; i++) {
					var pair = vars[i].split("=");
					if(pair[0] == variable) {
						return pair[1];
					}
				}
				return(false);
			}
			$('.closeIcon').click(function() {
				win_close()
			})
			$('.topImg').click(function() {
				$("html,body").animate({
					scrollTop: 0
				}, 1000)
			})

			function win_close() {
				// 判断是否支持WeixinJSBridge 微信环境
				if(typeof WeixinJSBridge !== 'undefined') {
					WeixinJSBridge.call('closeWindow') // 微信自带的关闭窗口WeixinJSBridge.call("closeWindow")
				} else {
					// H5 环境
					if(navigator.userAgent.indexOf('MSIE') > 0) {
						if(navigator.userAgent.indexOf('MSIE 6.0') > 0) {
							window.opener = null
							window.close()
						} else {
							window.open('', '_top')
							window.top.close()
						}
					} else if(navigator.userAgent.indexOf('Firefox') > 0) {
						window.location.href = 'about:blank '
					} else {
						window.opener = null
						window.open('', '_self', '')
						window.close()
					}
				}
			}

			function getYearMonth(date) {
				// 将日期以空格隔开，即['2020-06-13', '17:10:09']
				date = (date + '').split(/[ ]+/);
				let result = [];
				let reg = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
				// 用截取出来的年月日进行正则表达式匹配
				reg.exec(date[0]);
				result.push(RegExp.$1); //获取匹配到的第一个子匹配，即‘2020’
				result.push(RegExp.$2);
				result.push(RegExp.$3);
				return result.join('/');
			}
			if(_url.indexOf("?") != -1) {
				_Trace_code = getQueryVariable("trace_code")
			};
			$.ajax({
				url: "http://test.ccsc58.com/pty_qrcode_info",
				type: "get",
				data: {
					trace_code: _Trace_code,
				},
				dataType: 'json',
				success: function(res) {
					//                   return false;
					if(res.code == 200 && res.data != null) {
						$('.picihaoTxt').text(res.data.picihao)
						$('.zhongmiaomingcheng').text(res.data.zhongmiaomingcheng)
						$('.createTime').text(getYearMonth(res.data.create_time))
						$('.overTime').text(res.data.over_time == null ? '' : '-' + getYearMonth(res.data.over_time))
//						if(res.data.over_time == null) {
//							$('.time').html(`	<span>批次时间区间：`)
//						}
						 $('.parkNameTxt').text(res.data.yuanqu.greenhouse.name)
						$('.parkTimeTxt').text(res.data.yuanqu.build_time)
						$('.parkAreaTxt').text(res.data.yuanqu.area)
						$('.parkChengfemTxt').text(res.data.yuanqu.turangchengfen)
						if(res.data.yuanqu.greenhouse.image) {
							if(res.data.yuanqu.greenhouse.image.includes(',')) {
								let imgsrc = res.data.yuanqu.greenhouse.image.split(',')
								$('.curImg').attr('src', imgsrc[0])
							} else {
								let imgsrc = res.data.yuanqu.greenhouse.image
								$('.curImg').attr('src', imgsrc)
							}
						}
						if(res.data.zhuisu_list.length > 0) {
							let html = ''
							res.data.zhuisu_list.map((item, index) => {
								html += `<div class="item">
									<span class="symbolIcon"></span>
									<p>${item.name}</p>
									<p>${item.content}</p>
									<p>平均温湿度 ${item.average_temperature}℃ /${item.average_humidity}%RH</p>
									<p class="timebg">${item.start_time}——${item.end_time}</p>
								</div>`
							})
							$('.container-fluid').append(html)
							$('.topImg').show()
						} else {
							$('.topImg').hide()

						}
					} else {
						$('.content').html('').append(`<div class="imgbox">
								<img src='img/none.png' class="curImg" />
								<span>暂无数据</span>
							</div>`)
					};
				},
				error: function(err) {
					console.log(err)
				}
			})

		})
	</script>

</html>